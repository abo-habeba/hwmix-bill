import{r as n,P as U,ap as D,z as w,w as b,o as c,k as x,j as s,d as o,ah as N,b as g,a1 as O,c as T,aC as j,a as q,a2 as E,a6 as h,az as S,au as F,Y as z,a9 as k,q as A,U as L,X as M,Z as R}from"./index-CBThZYUU.js";const X={key:0,class:"d-flex flex-column align-center justify-center",style:{height:"150px"}},Z={__name:"PayInstallmentDialog",props:{installment:Object,modelValue:Boolean,directPay:{type:Boolean,default:!0}},emits:["update:modelValue","update:installment"],setup(f,{emit:B}){const m=f,C=B,r=n(!1),p=n(!1),l=n({amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]}),V=n([]),i=n([]);U(async()=>{var t;try{const e=await D("payment-methods",{per_page:-1},!0,!1,!1);V.value=e||[];const a=e.find(u=>{var v;return((v=u.code)==null?void 0:v.trim().toLowerCase())==="cash"});a&&(l.value.payment_method_id=a.id);const d=w();if((t=d.user)!=null&&t.cashBoxes&&(i.value=d.user.cashBoxes||[],i.value.length)){const u=i.value.find(v=>v.is_default);u&&(l.value.cash_box_id=u.id)}}catch(e){console.error("Error fetching payment methods or cashboxes:",e)}});const y=n(!1);b(()=>m.installment,t=>{if(t){console.log("📥 استلام قسط جديد:",t),console.log("installmentReady",y.value),l.value.installment_ids=[t.id],l.value.amount=t.remaining,l.value.user_id=t.user_id,l.value.installment_plan_id=t.installment_plan_id,l.value.notes="",l.value.paid_at=new Date().toISOString().substr(0,10);const e=V.value.find(d=>{var u;return((u=d.code)==null?void 0:u.trim().toLowerCase())==="cash"});l.value.payment_method_id=(e==null?void 0:e.id)||"";const a=i.value.find(d=>d.is_default);l.value.cash_box_id=(a==null?void 0:a.id)||null,y.value=!0}}),b(()=>y.value,t=>{console.log("🔄 مراقبة جاهزية القسط:",t),t&&m.directPay&&(console.log("🚀 البيانات جاهزة والدفع مباشر، جاري التنفيذ..."),P())}),b(()=>m.modelValue,t=>{r.value=t});function _(){l.value={amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]},r.value=!1,C("update:modelValue",!1)}function P(){!m.directPay&&!p.value||R("installment-payment/pay",l.value,!1,!1).then(t=>{console.log("تم تحديث القسط:",t),C("update:installment",t),_()}).catch(t=>{_(),console.error("Error submitting payment:",t)})}return(t,e)=>(c(),x(M,{modelValue:r.value,"onUpdate:modelValue":e[6]||(e[6]=a=>r.value=a),"max-width":"400px"},{default:s(()=>[o(L,null,{default:s(()=>[o(N,null,{default:s(()=>e[7]||(e[7]=[g("سداد القسط")])),_:1}),o(O,null,{default:s(()=>[f.directPay?(c(),T("div",X,[o(j,{indeterminate:"",color:"primary",class:"mb-2"}),e[8]||(e[8]=q("p",null,"جاري الدفع...",-1))])):(c(),x(E,{key:1,ref:"payForm",modelValue:p.value,"onUpdate:modelValue":e[5]||(e[5]=a=>p.value=a)},{default:s(()=>[o(h,{class:"ma-1",label:"مبلغ السداد",modelValue:l.value.amount,"onUpdate:modelValue":e[0]||(e[0]=a=>l.value.amount=a),type:"number",rules:[a=>!!a||"المبلغ مطلوب",a=>a>0||"المبلغ يجب أن يكون أكبر من صفر"],required:""},null,8,["modelValue","rules"]),o(h,{class:"ma-1",label:"تاريخ السداد",modelValue:l.value.paid_at,"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.paid_at=a),type:"date"},null,8,["modelValue"]),o(S,{class:"ma-1",label:"طريقة الدفع",modelValue:l.value.payment_method_id,"onUpdate:modelValue":e[2]||(e[2]=a=>l.value.payment_method_id=a),items:V.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر طريقة الدفع"],required:""},null,8,["modelValue","items","rules"]),o(S,{class:"ma-1",label:"صندوق النقدية",modelValue:l.value.cash_box_id,"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.cash_box_id=a),items:i.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر صندوق النقدية"]},null,8,["modelValue","items","rules"]),o(h,{class:"ma-1",label:"ملاحظات",modelValue:l.value.notes,"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.notes=a)},null,8,["modelValue"])]),_:1},8,["modelValue"]))]),_:1}),o(F,null,{default:s(()=>[o(z),o(k,{text:"",onClick:_},{default:s(()=>e[9]||(e[9]=[g("إلغاء")])),_:1}),f.directPay?A("",!0):(c(),x(k,{key:0,color:"primary",disabled:!p.value,onClick:P},{default:s(()=>e[10]||(e[10]=[g("دفع القسط")])),_:1},8,["disabled"]))]),_:1})]),_:1})]),_:1},8,["modelValue"]))}};export{Z as _};

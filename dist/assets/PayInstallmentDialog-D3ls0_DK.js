import{_ as I,r as i,P as M,aj as R,z as X,w,o as u,k as g,j as d,d as o,ao as Y,b as x,a1 as Z,c as f,ay as G,a as c,a2 as H,a6 as B,av as A,V as J,t as b,q as U,M as K,F as Q,A as W,ap as $,Y as ee,a9 as j,U as ae,X as le,Z as te}from"./index-Bkhlk-wl.js";const se={key:0,class:"d-flex flex-column align-center justify-center",style:{height:"150px"}},ue={key:2,if:"dataReturn",class:"d-flex flex-column align-center justify-center py-1"},oe={class:"text-h6 mb-2"},ne={key:0,class:"d-flex flex-column align-center justify-center text-subtitle-1 success--text"},ie={key:1,dense:"",class:"w-100"},de={style:{"font-weight":"bold","font-size":"18px"}},re={key:0},me={key:1},ve={key:2},pe={__name:"PayInstallmentDialog",props:{installment:Object,modelValue:Boolean,directPay:{type:Boolean,default:!0}},emits:["update:modelValue","update:installment"],setup(P,{emit:E}){const _=P,F=E,y=i(!1),r=i(null),m=i(!1),C=i(!1),v=i(!1),l=i({amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]}),D=i([]),k=i([]),h=i(null);M(async()=>{var s;try{const e=await R("payment-methods",{per_page:-1},!0,!1,!1);D.value=e||[];const t=e.find(n=>{var V;return((V=n.code)==null?void 0:V.trim().toLowerCase())==="cash"});t&&(l.value.payment_method_id=t.id);const p=X();if((s=p.user)!=null&&s.cashBoxes){k.value=p.user.cashBoxes||[];const n=k.value.find(V=>V.is_default);n&&(l.value.cash_box_id=n.id)}}catch(e){console.error("Error fetching payment methods or cashboxes:",e)}});const S=i(!1);w(()=>_.installment,s=>{if(s){console.log("📥 استلام قسط جديد:",s),l.value.installment_ids=[s.id],l.value.amount=s.remaining,l.value.user_id=s.user_id,l.value.installment_plan_id=s.installment_plan_id,l.value.notes="",l.value.paid_at=new Date().toISOString().substr(0,10);const e=D.value.find(p=>{var n;return((n=p.code)==null?void 0:n.trim().toLowerCase())==="cash"});l.value.payment_method_id=(e==null?void 0:e.id)||"";const t=k.value.find(p=>p.is_default);l.value.cash_box_id=(t==null?void 0:t.id)||null,l.value.payment_method_id&&l.value.cash_box_id?S.value=!0:console.warn("⚠️ بيانات ناقصة تمنع تنفيذ الدفع التلقائي.")}},{immediate:!0}),w(()=>S.value,s=>{console.log("🔄 مراقبة جاهزية القسط:",s),s&&_.directPay&&!v.value&&!m.value&&(console.log("🚀 البيانات جاهزة والدفع مباشر، جاري التنفيذ..."),N())}),w(()=>_.modelValue,s=>{y.value=s,s&&!v.value&&_.installment&&(l.value.amount=_.installment.remaining||_.installment.amount)});function L(){l.value={amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]},S.value=!1,v.value=!1,m.value=!1,r.value=null,y.value=!1,F("update:modelValue",!1),h.value&&h.value.resetValidation()}async function N(){var s,e;if(!_.directPay){const{valid:t}=await h.value.validate();if(!t)return}m.value=!0;try{const t=await te("installment-payment/pay",l.value,!1,!1);r.value=t,v.value=!0,m.value=!1,F("update:installment",t)}catch(t){console.error("❌ Error submitting payment:",t),m.value=!1,alert("حدث خطأ أثناء عملية الدفع: "+(((e=(s=t.response)==null?void 0:s.data)==null?void 0:e.message)||t.message)),v.value=!1,r.value=null}}return(s,e)=>(u(),g(le,{modelValue:y.value,"onUpdate:modelValue":e[6]||(e[6]=t=>y.value=t),"max-width":"400px",persistent:""},{default:d(()=>[o(ae,null,{default:d(()=>[o(Y,null,{default:d(()=>e[7]||(e[7]=[x("سداد القسط")])),_:1}),o(Z,null,{default:d(()=>{var t,p,n,V,O,T,q,z;return[y.value&&m.value?(u(),f("div",se,[o(G,{indeterminate:"",color:"primary",class:"mb-2"}),e[8]||(e[8]=c("p",null,"جاري الدفع...",-1))])):y.value&&!m.value&&!v.value&&!P.directPay?(u(),g(H,{key:1,ref_key:"payForm",ref:h,modelValue:C.value,"onUpdate:modelValue":e[5]||(e[5]=a=>C.value=a)},{default:d(()=>[o(B,{class:"ma-1",label:"مبلغ السداد",modelValue:l.value.amount,"onUpdate:modelValue":e[0]||(e[0]=a=>l.value.amount=a),type:"number",rules:[a=>!!a||"المبلغ مطلوب",a=>a>0||"المبلغ يجب أن يكون أكبر من صفر"],required:""},null,8,["modelValue","rules"]),o(B,{class:"ma-1",label:"تاريخ السداد",modelValue:l.value.paid_at,"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.paid_at=a),type:"date"},null,8,["modelValue"]),o(A,{class:"ma-1",label:"طريقة الدفع",modelValue:l.value.payment_method_id,"onUpdate:modelValue":e[2]||(e[2]=a=>l.value.payment_method_id=a),items:D.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر طريقة الدفع"],required:""},null,8,["modelValue","items","rules"]),o(A,{class:"ma-1",label:"صندوق النقدية",modelValue:l.value.cash_box_id,"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.cash_box_id=a),items:k.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر صندوق النقدية"]},null,8,["modelValue","items","rules"]),o(B,{class:"ma-1",label:"ملاحظات",modelValue:l.value.notes,"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.notes=a)},null,8,["modelValue"])]),_:1},8,["modelValue"])):y.value&&!m.value&&v.value&&r.value?(u(),f("div",ue,[o(J,{color:"success",size:"50",class:"mb-1"},{default:d(()=>e[9]||(e[9]=[x("ri-checkbox-circle-fill")])),_:1}),e[12]||(e[12]=c("h3",{class:"mb-2"},"تمت عملية الدفع بنجاح!",-1)),c("p",oe,"المبلغ المدفوع : "+b((p=(t=r.value)==null?void 0:t.payment_record)==null?void 0:p.amount_paid),1),(V=(n=r.value)==null?void 0:n.payment_record)!=null&&V.excess_amount?(u(),f("p",ne,[e[10]||(e[10]=c("span",null,"تم دفع الاقساط بنجاح،",-1)),c("span",null,"ولكن يوجد مبلغ متبقي بقيمة : "+b((T=(O=r.value)==null?void 0:O.payment_record)==null?void 0:T.excess_amount),1)])):U("",!0),o(K,{class:"my-4",style:{width:"80%"}}),e[13]||(e[13]=c("p",{class:"k"},"الأقساط التي تم دفعها",-1)),(z=(q=r.value)==null?void 0:q.paid_installments)!=null&&z.length?(u(),f("div",ie,[(u(!0),f(Q,null,W(r.value.paid_installments,a=>(u(),f("div",{key:a.id},[c("div",null,[e[11]||(e[11]=c("span",null,"قسط رقم ",-1)),c("span",de,b(a.installment_number),1),x(" ( "+b(a.due_date.split(" ")[0])+" ) ",1),a.remaining!="0.00"?(u(),f("span",re," باقي "+b(a.remaining),1)):(u(),f("span",me," مدفوع بالكامل "+b(a.amount),1))])]))),128))])):(u(),f("p",ve,"لا توجد أقساط مدفوعة لعرضها."))])):U("",!0)]}),_:1}),o($,null,{default:d(()=>[o(ee),v.value?(u(),g(j,{key:1,text:"",onClick:L},{default:d(()=>e[15]||(e[15]=[x("إغلاق")])),_:1})):(u(),g(j,{key:0,text:"",onClick:L},{default:d(()=>e[14]||(e[14]=[x("إلغاء")])),_:1})),y.value&&!m.value&&!v.value&&!P.directPay?(u(),g(j,{key:2,color:"primary",disabled:!C.value,onClick:N},{default:d(()=>e[16]||(e[16]=[x("دفع القسط")])),_:1},8,["disabled"])):U("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},ce=I(pe,[["__scopeId","data-v-982425d6"]]);export{ce as P};

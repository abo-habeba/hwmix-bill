import{r as i,Q as w,ap as B,A as O,w as D,o as U,l as T,k as d,d as n,W as F,ai as $,b as V,a1 as q,a2 as A,a6 as k,ay as C,au as M,Z as L,a9 as P,Y as N,$ as j,_ as Q,c as R,t as S,aq as W,bh as Y,F as Z}from"./index-DDPz-M61.js";const z={__name:"PayInstallmentDialog",props:{installment:Object,modelValue:Boolean},emits:["update:modelValue","update:installment"],setup(x,{emit:y}){const r=x,_=y,p=i(!1),v=i(!1),l=i({amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]}),c=i([]),m=i([]);w(async()=>{var o;try{const e=await B("payment-methods");c.value=e;const a=e.find(s=>{var t;return((t=s.code)==null?void 0:t.trim().toLowerCase())==="cash"});a&&(l.value.payment_method_id=a.id);const u=O();if((o=u.user)!=null&&o.cashBoxes){m.value=u.user.cashBoxes||[];const s=m.value.find(t=>t.is_default);s&&(l.value.cash_box_id=s.id)}}catch(e){console.error("Error fetching payment methods or cashboxes:",e)}}),D(()=>r.installment,o=>{if(console.log("📥 استلام قسط جديد:",r.installment),console.log("🔄 تحديث القسط:",o),o){l.value.installment_ids=[o.id],l.value.amount=o.remaining,l.value.user_id=o.user.id,l.value.installment_plan_id=o.installment_plan_id,l.value.notes="",l.value.paid_at=new Date().toISOString().substr(0,10);const e=c.value.find(u=>{var s;return((s=u.code)==null?void 0:s.trim().toLowerCase())==="cash"});l.value.payment_method_id=(e==null?void 0:e.id)||"";const a=m.value.find(u=>u.is_default);l.value.cash_box_id=(a==null?void 0:a.id)||null}}),D(()=>r.modelValue,o=>{p.value=o});function f(){p.value=!1,_("update:modelValue",!1)}function h(){v.value&&j("installment-payment/pay",l.value).then(o=>{console.log("تم تحديث القسط:",o),_("update:installment",o.installments),f()}).catch(o=>{console.error("Error submitting payment:",o)})}return(o,e)=>(U(),T(N,{modelValue:p.value,"onUpdate:modelValue":e[6]||(e[6]=a=>p.value=a),"max-width":"400px"},{default:d(()=>[n(F,null,{default:d(()=>[n($,null,{default:d(()=>e[7]||(e[7]=[V("سداد القسط")])),_:1}),n(q,null,{default:d(()=>[n(A,{ref:"payForm",modelValue:v.value,"onUpdate:modelValue":e[5]||(e[5]=a=>v.value=a)},{default:d(()=>[n(k,{label:"مبلغ السداد",modelValue:l.value.amount,"onUpdate:modelValue":e[0]||(e[0]=a=>l.value.amount=a),type:"number",rules:[a=>!!a||"المبلغ مطلوب",a=>a>0||"المبلغ يجب أن يكون أكبر من صفر"],required:""},null,8,["modelValue","rules"]),n(k,{label:"تاريخ السداد",modelValue:l.value.paid_at,"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.paid_at=a),type:"date"},null,8,["modelValue"]),n(C,{label:"طريقة الدفع",modelValue:l.value.payment_method_id,"onUpdate:modelValue":e[2]||(e[2]=a=>l.value.payment_method_id=a),items:c.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر طريقة الدفع"],required:""},null,8,["modelValue","items","rules"]),n(C,{label:"صندوق النقدية",modelValue:l.value.cash_box_id,"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.cash_box_id=a),items:m.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر صندوق النقدية"]},null,8,["modelValue","items","rules"]),n(k,{label:"ملاحظات",modelValue:l.value.notes,"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.notes=a)},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),n(M,null,{default:d(()=>[n(L),n(P,{text:"",onClick:f},{default:d(()=>e[8]||(e[8]=[V("إلغاء")])),_:1}),n(P,{color:"primary",disabled:!v.value,onClick:h},{default:d(()=>e[9]||(e[9]=[V("دفع القسط")])),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},G={__name:"InstallmentsDataTable",setup(x){const y=[{title:"رقم القسط",key:"installment_number"},{title:"العميل",key:"user.nickname",sortable:!1},{title:"تاريخ الاستحقاق",key:"due_date"},{title:"قيمة القسط",key:"amount"},{title:"الحالة",key:"status"},{title:"المتبقي",key:"remaining"},{title:"الإجراءات",key:"actions",sortable:!1}],r=i([]),_=i(!1),p=i(null),v=i(1),l=i(10),c=i(0),m=i(!1),f=i({page:1,itemsPerPage:10,sortBy:["due_date"],sortDesc:[!1]});function h(u){p.value=u,_.value=!0}function o(u){u.forEach(s=>{const t=r.value.findIndex(g=>g.id===s.id);t!==-1&&(r.value[t]=s)})}async function e(){m.value=!0;const{page:u,itemsPerPage:s,sortBy:t}=f.value,g=t.length?t[0].key:"due_date",I=t.length&&t[0].order?t[0].order:"asc",E={page:u||1,limit:s||10,sort_by:g,sort_order:I};try{const b=await B("installments",E,!0,!0,!0);r.value=b.data,c.value=b.total}catch(b){console.error("فشل في جلب الأقساط:",b)}finally{m.value=!1}}w(()=>{e()}),D(()=>f.value.page,()=>{e()});function a({item:u,index:s}){return{class:u.status==="تم الدفع"?"paid-row":"unpaid-row","data-index":s}}return(u,s)=>(U(),R(Z,null,[n(W,{"item-value":"id",options:f.value,"onUpdate:options":[s[0]||(s[0]=t=>f.value=t),e],headers:y,items:r.value,"items-length":c.value,loading:m.value,hover:"","show-current-page":"","row-props":a,"loading-text":"جاري تحميل البيانات","no-data-text":"لا توجد بيانات","items-per-page-text":"عدد الصفوف في الصفحة"},{"item.index":d(({index:t})=>[V(S(t+1),1)]),"item.actions":d(({item:t})=>[n(P,{color:t.status==="تم الدفع"?"grey":"primary",disabled:t.status==="تم الدفع",density:"compact",onClick:g=>h(t)},{default:d(()=>[V(S(t.status==="تم الدفع"?"تم الدفع":"دفع القسط"),1)]),_:2},1032,["color","disabled","onClick"])]),_:1},8,["options","items","items-length","loading"]),n(Y,{modelValue:v.value,"onUpdate:modelValue":s[1]||(s[1]=t=>v.value=t),length:Math.ceil(c.value/l.value),class:"mt-4","show-first-last":!0,"total-visible":5},null,8,["modelValue","length"]),n(z,{modelValue:_.value,"onUpdate:modelValue":s[2]||(s[2]=t=>_.value=t),installment:p.value,"onUpdate:installment":o},null,8,["modelValue","installment"])],64))}},H=Q(G,[["__scopeId","data-v-eed78d15"]]),K={__name:"installments",setup(x){return(y,r)=>(U(),T(F,{class:"pa-0",title:"الاقساط"},{default:d(()=>[n(H)]),_:1}))}};export{K as default};
